# 統合設計書（要件定義 + システム設計 + チャット実装）

## 1. 目的・スコープ
- 本書は「要件定義書」「システム設計書」「チャット機能実装設計書」を統合し、矛盾の解消と不足項目の補完を行った最終版です。
- バージョンや主要技術選定は既存文書の記載を尊重し、変更しません。

## 2. 主要要件（統合）
- 機能（MVP）:
  - 掲示板での即時マッチ → 20分間のチャット（UI上の表示制御）
  - テキスト（最大500文字）/ 画像（JPEG/PNG, 各2MB, 1メッセージ最大5枚）
  - 既読/未読、横スクロールでチャット切替、広告（課金で非表示）
- 非機能:
  - 通信暗号化: TLS 1.3（AES-256-GCM相当）
  - 同時ユーザー: MVP 10-50（将来目標 100-500）
  - 可用性: 99%
  - レート/接続制限: 1デバイス100 req/分, 1ユーザー最大2デバイス, 1IP最大5デバイス
  - データ保持: 20分はUI非表示のみ、24時間でサーバー削除（Cron）

## 3. 全体アーキテクチャ（統合）
- iOS(Swift 6.1 + SwiftUI + SwiftData)
- Backend(Nest.js 11.1.6 + Socket.io 4.8.1, Node.js 24 LTS)
- DB(RDS PostgreSQL 17, BYTEAで画像)
- Push(SNS + APNs), 監視(CloudWatch), LB(ALB)
- 画像配信は「RDS直接」ではなく「Nest.js REST API経由」。WebSocketはメタデータ配信。

## 4. 認証・認可
- 匿名登録後、サーバーがデバイスIDベースの匿名JWTを発行。
- 全API/WebSocketでJWT検証。
- アクセス制御: 参加権限ルームのみ、送信者検証、レート/デバイス/IP制限を適用。

## 5. チャット機能（統合仕様）
- 20分制限: サービス上の「表示制御」。20分経過後はUIで非表示。DBは24時間後に削除。
- メッセージ: テキスト最大500文字。画像はJPEG/PNG・各2MB、1メッセージ最大5枚。
- 画像保存: `message_attachments` にBYTEA保存。メタデータは別カラム。
- 画像取得: REST `GET /messages/:messageId/attachments/:attachmentId`（JWT必須）。
- WebSocket: ルーム参加・メッセージ/既読イベント・timer:expired通知（UI切替トリガ）。

## 6. データベース（統合方針）
- サーバー: `users, posts, matches, chat_rooms, room_participants, messages, message_attachments, notifications, ad_banners, user_subscriptions`
- クライアント(SwiftData): ローカルキャッシュ用に`Message`へ`imageData`保持は可（サーバーは添付を別テーブルで管理）。
- 期限: 24時間で容量管理削除（深夜2時、Cron、トランザクション/ログあり）。
- **実装状況**: PostgreSQL 17 + Prisma 6.16.1で初回マイグレーション完了（2025年9月13日）

## 7. セキュリティ
- 通信: TLS 1.3。
- ヘッダー: Strict-Transport-Security, X-Content-Type-Options, Referrer-Policy, X-Frame-Options。
- レート制限: 1デバイス100 req/分。ユーザー最大2デバイス。1IP最大5デバイス。
- 同意/通報: 画像送信前の多段階同意、ワンタップ通報。

## 8. 監視・運用
- CloudWatch Logs/Metrics/Alarms、接続数・遅延・エラー率・容量・削除処理を可視化。
- デプロイ: EC2 + PM2 + Nginx、ALB経由。RDSは手動スケーリング、任意で読み取りレプリカ。

## 9. 既知の制約
- RDSの自動スケーリングは行わず、手動スケーリング。小規模前提。
- バックアップはコスト都合で無効化可能（リスクは受容）。

## 10. 変更・統合で解消した矛盾
- 画像配信: 「RDS直接配信」→「Nest.js REST API経由」に統一。
- 20分: 「削除」→「UI非表示」。削除は24時間で実施。
- 接続制限: 「1IP=2 or 5」→「1IP=5」。加えて「1ユーザー=2デバイス」を明記。
- スケーリング: 「RDS自動スケーリング」→「手動 + 任意Read Replica」。
- 暗号化表現: 「AES-256」→「TLS 1.3（AES-256-GCM相当）」で具体化。


